# Лабораторная работа №2

> Для проверки работы образов нужно открыть ссылку [*localhost:8000*](http://localhost:8000)

## Плохой Dockerfile.bad

#### Сборка и запуск
```bash
docker build -f Dockerfile.bad -t clouds-bad-example .
docker run -it --name bad-example -p 8000:8000 clouds-bad-example
```

### Ошибки:

#### 1. Использование тэга *latest* вместо указания конкретной версии

```Dockerfile
FROM python:latest
```

Использование *latest* может привести к непредсказуемому поведению при сборке, так как Docker будет использовать последнюю доступную версию базового образа. Это может вызвать несовместимость и привести к ошибкам в будущем.

#### 2. Перенос лишних файлов в образ

```Dockerfile
COPY . .
```

Копирование всех файлов из текущей директории в образ, включая лишние файлы, может значительно увеличить его размер и ухудшить производительность. Это также может представлять потенциальные угрозы безопасности.

#### 3. Обновление пакетов отдельной командой и установка лишних программ

```Dockerfile
RUN apt-get update
RUN apt-get install -y iputils-ping htop tree
```

Разделение обновления пакетов и установки программ на отдельные слои делает образ менее эффективным, так как каждый слой добавляет дополнительные накладные расходы. Установка лишних программ также увеличивает размер образа.

Так же обновление пакетов в отдельном слое опасно тем, что оно кешируется отдельно от слоя с установкой программ. Это может привести к ошибкам при добавлении новых программ в образ.

#### 4. Хранение чувствительной информации в Dockerfile 

```Dockerfile
ENV API_TOKEN=qwerty123
```

Хранение чувствительных данных, таких как API токены, непосредственно в Dockerfile делает их доступными в истории команд сборки и в image, что представляет серьезный риск безопасности.

#### 5. Запуск нескольких программ в команде CMD

```Dockerfile
CMD ["python3", "src/main.py", "&&", "tail", "-f", "src/logs/log1.log"]
```

Запуск нескольких программ в одной команде CMD с использованием оператора && может привести к неожиданному поведению и затруднить управление контейнером. Это может вызвать проблемы с мониторингом и управлением контейнером.

#### 6. Использование пользователя *root*

Необходимо избегать запуска контейнеров с правами root, так как это может представлять угрозу для безопасности.

## Хороший Dockerfile.good

#### Сборка и запуск
```bash
docker build --build-arg API_TOKEN=qwerty456 -f Dockerfile.good -t clouds-good-example .
docker run -it --name good-example -p 8000:8000 clouds-good-example
```

### Исправление ошибок:

#### 1. Вместо тэга *latest* указана конкретная версия *3.11-slim*

```Dockerfile
FROM python:3.11-slim
```

Указание конкретной версии базового образа обеспечивает стабильность и предсказуемость сборки, а также может уменьшить размер итогового образа, если использовать специальные тэги, такие как *slim*.

#### 2. В image переносятся только нужные для приложения файлы

```Dockerfile
WORKDIR /app
COPY src/main.py src/requirements.txt ./
```

Копирование только необходимых файлов и директорий в образ уменьшает его размер и снижает риск безопасности.

#### 3. Обновление пакетов и их установка находятся в одном слое

```Dockerfile
RUN apt-get update && \
    apt-get install iputils-ping && \
    pip3 install -r requirements.txt
```

Обновление пакетов и установка программ в одной команде сокращает количество слоев и уменьшает размер образа. Также при добавлении новой программы весь слой будет собран заново, что исключит проблемы с обновлением зависимостей.

#### 4. Чувствительная информация передается в Dockerfile непосредственно при сборке образа

```Dockerfile
ARG API_TOKEN
ENV API_TOKEN=${API_TOKEN}
```

Передача чувствительных данных через аргументы сборки и переменные среды обеспечивает безопасное хранение такой информации и предотвращает её разглашение в истории команд сборки или образе.

```bash
docker build --build-arg API_TOKEN=qwerty456 -f Dockerfile.good -t clouds-good-example .
```

#### 5. В CMD запускается только главный процесс

```Dockerfile
CMD ["python3", "main.py"]
```

Запуск только главного процесса в команде CMD упрощает управление и мониторингом контейнером, обеспечивая правильное функционирование.

#### 6. Использование нового пользователя вместо *root*

```Dockerfile
USER $USERNAME
```

Для ограничения доступа к системе создается новый пользователь, под которым происходит запуск основного приложения.

## Плохие практики по использованию контейнера

#### 1. Изменение контейнера вручную
Изменение контейнера вручную (например, через exec) может привести к состоянию, которое не совпадает с определением Dockerfile и вызвать проблемы масштабирования.

#### 2. Неочищенное завершение контейнера
Не завершение контейнера и отсутствие удаления могут привести к накоплению неиспользуемых ресурсов.

#### 3. Удаление контейнера без сохранения данных
Если важные данные хранятся в контейнере, удаление контейнера без сохранения данных может вызвать потерю информации.

